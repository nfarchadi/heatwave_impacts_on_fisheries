---
title: "Impacts of MHWs on NW Atlantic PLL Fishery"
author: "Nima Farchadi"
output: 
  html_document:
    toc: True
    toc_float: true
    code_folding: hide
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(here)
library(raster)
library(rnaturalearth)
library(lubridate)
library(sf)
library(viridis)
library(gt)
library(kableExtra)
library(zoo)
library(gganimate)
```

# Background

Purpose of this study is to see how MHWs in the NW Atlantic and NE Pacific are affecting the spatiotemporal distribution of pelagic fisheries, specifically the pelagic longline and albacore troll fleet, respectively. 

Data for the fleets are daily gridded AIS presences (binned by flag) and were obtained from Global Fishing Watch. Currently the data's temporal extent is from 2012 - 2020. 

For this example, I will be only focusing on the NW Atlantic Pelagic Longline fleet* as most work has been focused on this fishery so far.

*AIS data for this fishery only spanned from 2013-2020 in the NWA region

```{r}
#load in data
NWA_PLL<-here("data","AIS_processed","NWA_PLL","Pres_Abs_2013to2020_NWA_USA_PLL_onlyfishing_v2_1to1ratio_absenceconstrained_convexhull_v2_enhanced.rds") %>% readRDS()

#map a map to see the data
#retreiving that data for the continents 
world <- ne_countries(scale = "medium", returnclass = "sf")

NWA_PLL %>% filter(Pres_abs == 1) %>%   ggplot() +
  #geom_sf(data = world, color= "black", fill = "grey" ) + #bring in world data
  geom_path(data = map_data("world"),
            aes(x=long, y=lat, group = group)) +
  coord_fixed(xlim = c(-100,-30), ylim = c(10,50)) + #changing the extent
  ylab("Latitude") + xlab("Longitude") + 
  labs(title = "NW Atlantic Pelagic Longline Fleet")+
  geom_point(aes(x=X,y=Y))+
  theme_bw(base_size = 10) +
  theme(axis.text=element_text(size=20))+
  theme(legend.title=element_text(size=20))+
  theme(legend.text=element_text(size=20))+
  #theme(plot.margin = unit(c(0.01,0.01,0.01,0.01), "cm"))+
  theme(strip.text = element_text(size = 20))+
  theme(axis.title = element_text(size = 20))
```

Vessel Distribution Model (VDM) was built for the fleet and daily predictions were made. Model validation showed high predictive skill, so I felt confident hindcasting to 2012 because there was a prominent MHW in Gulf of Marine, which was linked to disruptive impacts on several fisheries in the region (e.g. lobster, longfin squid, blue crabs) and I was interested if this also lead to impacts on the this fishery

```{r}
eval<-here("data","VDM_and_eval","NWA_PLL","brt_hoursabove1_VDM_eval_gbm_step.rds") %>% readRDS()

tb1<-eval$brt_k%>% gt() %>% as_raw_html()

tb2<-eval$brt_loo%>% gt() %>% as_raw_html()

data_tables <- data.frame(kfold = tb1, 
                          LOO = tb2)

data_tables %>% 
  gt() %>% 
  fmt_markdown(columns = everything()) %>% #render cell contents as html
  cols_label(kfold = "10 k-fold CV", 
             LOO = "Leave one year out CV")
```


## MHWs within Management Zones

To understand how MHWs were impacting the NW Atlantic Pelagic Longline fleet distribution, I looked at it under monthly timescales. This involved taking monthly means of the daily predictions as well as SST.

Additionally, for this analysis were we interested in exploring how MHWs are impacting the fleets distributions at different spatial scales: 1) the entire region and 2) within the PLL management zones (For this markdown I monstly be focusing on the latter). This is because we believe that under MHWs different management zones may become "winners" (i.e. gain in fishing habitat) while losers may tend to be "losers", and thus it is important to identify which zones are more vulnerable to a MHW. An full extent analysis may not capture this change in suitable habitat among regions as this extent is very large and these MHWs usually do not cover the whole extent.

Below are maps of suitable fishing habitat for the NW Atlantic PLL during September of 4 different years.

```{r}
NWA_PLL_monthpred<-stack("E:/VDM_results/NWA_PLL/monthly/predictions/NWA_PLL_monthly_predictions_2012to2020.nc")

tt<-as.yearmon(seq(as.Date("2012-01-01"),as.Date("2020-12-01"),by="month"))
names(NWA_PLL_monthpred)<-tt
NWA_PLL_monthpred<-setZ(NWA_PLL_monthpred,tt)
NWA_PLL_monthpred_df<-rasterToPoints(NWA_PLL_monthpred[[c(9,33,57,93)]]) %>% as.data.frame() %>% gather(key="date",value="Habitat",-x,-y)

NWA_PLL_zones<-sf::st_read("C:/Users/nfarc/Desktop/RCodes_Shapefiles/Shapefiles/NWA_PLL_MangementZone/Zones_PLL.shp", crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")

NWA_PLL_zones<-st_transform(NWA_PLL_zones)

NWA_PLL_zones$ET_ID<-c("CAR","FEC","GOM",
                       "MAB","NCA","NEC",
                       "NED","SAB","SAR",
                       "TUN","TUS")

NWA_PLL_zones<-NWA_PLL_zones[1:10,]

world<-sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))

ggplot()+
  geom_raster(NWA_PLL_monthpred_df, mapping = aes(x,y,fill = Habitat))+
  geom_sf(NWA_PLL_zones, mapping = aes(), fill = NA, color = "yellow")+
  geom_sf(data = world,
            mapping = aes())+
  coord_sf(xlim = c(-100,-30), ylim = c(10,50))+
  theme_bw()+
  scale_fill_viridis(option = "D")+
  facet_wrap(~date)+
  labs(x = 'Longitude', y = 'Latitude')
```

For reference these are the Management Zone with the acronyms
```{r}
ggplot()+
  geom_sf(NWA_PLL_zones, mapping = aes(), fill = NA, color = "yellow")+
  geom_sf_text(NWA_PLL_zones, mapping =aes(label =ET_ID),size=3,family="sans") +
  geom_sf(data = world,
            mapping = aes())+
  coord_sf(xlim = c(-100,-30), ylim = c(10,50))+
  theme_bw()+
  labs(x = 'Longitude', y = 'Latitude')
```

## Mangement Zone Analysis

To understand how suitable habitat changes in relation MHWs, I looked at a suite of metrics within each management zone:

* Model predictions
  + Mean suitability
  + Mean suitability anomaly
  + number of patches of suitable habitat
  + Total area (km^2)
  + Center of gravity
  + 25 and 75% quantile lat and lon of patches

* SST
  + Mean SST
  + Mean SST Anomaly of anomalously warmer waters (i.e. SST anomaly > 0)
  + Total area of anomalous warmer waters
  + 25 and 75% quantile lat and long of SST anomaly
  
* etc.

As an exmaple, one of the interesting results was how did proportion of suitable fishing habitat area change as a function of proportion of anomalously warmer SST area (i.e. SST anomaly* > 0). This analysis showed that the more northern management zones become more suitable ("winners") when SST anomaly area is larger and of high magnitude while more southern management zones become less suitable ("losers"). Just a reminder this was done at a monthly scale.

*I will discuss how SST anomaly was calculated in a later section [Concerns: calculating anomalies and identifying MHWs]
```{r}
#threshold 
thresh<-data.frame(threshold = 0.03590371)

NWAPLL_SSTanom<-readRDS(here("data","Mgmt_zone","NWAPLL_SSTanom.rds"))

#proportion plot
ggplot(NWAPLL_SSTanom, aes(x=prop_sstanom_area, y=prop_habitat_area,
                           color = max_SST_anom))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x)+
  scale_color_viridis(name=expression("SST Anomaly"),option ="inferno",
                      guide = guide_colorbar(barwidth = 1.5, 
                                             barheight = 20))+
  facet_wrap(~mgmt_zone, scales = "free")+
  theme_minimal()+
  labs(title="By Management Zone", x=expression("Proportion of Anomalously Hotter SST"~(km^2)), y=expression("Proportion of Suitable Fishing Habitat"~(km^2)))
```

This trend would not be seen if we look at the total extent.
```{r}
#total area plot
ggplot(NWAPLL_SSTanom, aes(x=prop_sstanom_area, y=prop_habitat_area,
                           color = max_SST_anom))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x)+
  scale_color_viridis(name=expression("SST Anomaly"),option ="inferno",
                      guide = guide_colorbar(barwidth = 1.5, 
                                             barheight = 20))+
  theme_minimal()+
  labs(title="Entire Spatial Extent", x=expression("Proportion of Anomalously Hotter SST"~(km^2)), y=expression("Proportion of Suitable Fishing Habitat"~(km^2)))
```

### Shifts in center of gravity

In addition to exploring how area of suitable habitat changes in response to area and magnitude of SST anomalies, I also explore how the pelagic longline fleet's distribution shifts in response to MHWs. This involved having to classify when a month within a management zone, which was done by finding the 90% quantile of mean SST anomaly within each management zone and when any month's mean SST anomaly was above the 90% quantile it was classified as a "MHW" and if not, it was classified as "near-average". Then all "MHW" and "near-average" month center of gravities were averaged, which can be viewed in the map below. The error bars represent the 25% and 75% quantile lat and lon of suitable habitat patches (they are not the center of gravity SD).

I will discuss more about identifying MHWs in the section below [Concerns: calculating anomalies and identifying MHWs] 

```{r}
#center of gravity between MHW years vs normal
NWA_SST_anom_monthly_metrics<-readRDS(here("data","Mgmt_zone","NWA_SST_anom_monthly_metrics.rds"))

quant90SST_mgmtzone<-NWA_SST_anom_monthly_metrics %>% 
  group_by(mgmt_zone) %>% 
  summarise(quant90=quantile(mean_SST_anom, probs = 0.90)) %>% 
  left_join(.,NWA_SST_anom_monthly_metrics, by = "mgmt_zone") %>% 
  mutate(MHW = ifelse(mean_SST_anom > quant90,1,0)) 

NWA_PLL_landscapemetrics_monthly<-readRDS(here("data","Mgmt_zone","NWA_PLL_landscapemetrics_monthly.rds"))

NWAPLL_lsm_month<-NWA_PLL_landscapemetrics_monthly %>% 
  mutate(month=lubridate::month(date),
         year=lubridate::year(date)) %>% 
  left_join(., quant90SST_mgmtzone, by = c("mgmt_zone","date")) %>%
  na.omit() %>% 
  group_by(MHW,mgmt_zone) %>% 
  summarise(COGx=mean(COGx, na.rm=TRUE),
            COGy=mean(COGy, na.rm=TRUE),
            X25=mean(X25, na.rm=TRUE),
            X75=mean(X75, na.rm=TRUE),
            Y25=mean(Y25, na.rm=TRUE),
            Y75=mean(Y75, na.rm=TRUE))


ggplot(data = NWAPLL_lsm_month) +
   #bring in world data +
  geom_sf(data = NWA_PLL_zones, color = "blue", fill=NA)+  #bring in EEZ data
  geom_sf(data = world, color= "black", fill = "grey") +
  geom_point(aes(COGx,COGy, color = as.factor(MHW)),shape = 3)+
  geom_errorbar(aes(x=COGx, ymin=Y25, ymax=Y75,color=as.factor(MHW)), 
                 show.legend = NA)+
  geom_errorbarh(aes(y=COGy, xmin=X25, xmax=X75,color=as.factor(MHW)),
                show.legend = NA)+
  coord_sf(xlim = c(-100, -20), ylim = c(0, 55), expand = TRUE) +
  ylab("Latitude") + xlab("Longitude") + theme_bw() +
  #scale_color_discrete(name = "Climate Regime")+
  scale_color_manual(name = "Climate Regime",
                     labels = c("Near-Average", "MHW"), 
                     values = c("blue", "red"))
```

### Winners and Losers

Similar to plots that others have made to show which species will be "winners" and "losers" in regards to projected climate change, I thought it would be interesting to use that format to show which management zone will be "winners" (gain in habitat) or "losers" (loss in habitat) during MHWs.

I tried exploring this at monthly scales to be inline with the other analyses above, however, it got rather "messy" and there is not a real clear pattern.
```{r}
#habitat change (winners and losers plot)
NWAPLL_total.area_monthly<-NWA_PLL_landscapemetrics_monthly %>% 
  mutate(month=lubridate::month(date),
         year=lubridate::year(date)) %>% 
  left_join(., quant90SST_mgmtzone, by = c("mgmt_zone","date")) %>% 
  dplyr::select(date,MHW,mgmt_zone,total.area.x)

NWAPLL_total.area_mgmtzone<-NWA_PLL_landscapemetrics_monthly %>% 
  mutate(month=lubridate::month(date),
         year=lubridate::year(date)) %>% 
  left_join(., quant90SST_mgmtzone, by = c("mgmt_zone","date")) %>%
  group_by(mgmt_zone) %>% 
  summarise(total.area_mean=mean(total.area.x, na.rm=TRUE))

habitat_change<-NWAPLL_total.area_monthly %>% 
  left_join(., NWAPLL_total.area_mgmtzone, by = c("mgmt_zone")) %>% 
  mutate(month=lubridate::month(date),
         year=lubridate::year(date)) %>%
  group_by(date,mgmt_zone) %>% 
  summarise(total.area = mean(total.area.x,na.rm=TRUE),
            total.area_mean = mean(total.area_mean, na.rm=TRUE),
            MHW = sum(MHW, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(habitat_change = ((total.area - total.area_mean) / total.area_mean)*100,
         #MHW= ifelse(MHW > 1, 1, 0),
         MHW = as.factor(MHW))



ggplot(habitat_change, aes(x=date,y=habitat_change, fill = MHW))+
  geom_bar(position=position_dodge(), stat="identity") +
  scale_fill_manual(values = c("blue", "red"))+
  facet_wrap(~mgmt_zone, scales = "free_x")+
  theme_bw()+
  ggtitle("Habitat change (month - mean / mean)") +
  labs(y="Percentage change", x="Date") +theme(legend.position="")+
  coord_flip()
```

Therefore, I thought it would be more interpretive to look at it yearly. However, this now meant I needed to classify what is a MHW **year** while what I have done previously was classify by **month**. For this I said any year what had more than 1 MHW month was classified as a MHW year. This was my attempt to capture more of those larger, more prominent MHWs and will likely get rid of the smaller less intense MHWs that possibly just occurred in one month of the whole year.
```{r}
habitat_change<-NWAPLL_total.area_monthly %>% 
  left_join(., NWAPLL_total.area_mgmtzone, by = c("mgmt_zone")) %>% 
  mutate(month=lubridate::month(date),
         year=lubridate::year(date)) %>%
  group_by(year,mgmt_zone) %>% 
  summarise(total.area = mean(total.area.x,na.rm=TRUE),
            total.area_mean = mean(total.area_mean, na.rm=TRUE),
            MHW = sum(MHW, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(habitat_change = ((total.area - total.area_mean) / total.area_mean)*100,
         MHW= ifelse(MHW > 1, 1, 0),
         MHW = as.factor(MHW))



ggplot(habitat_change, aes(x=year,y=habitat_change, fill = MHW))+
  geom_bar(position=position_dodge(), stat="identity") +
  scale_fill_manual(values = c("blue", "red"))+
  facet_wrap(~mgmt_zone, scales = "free_x")+
  theme_bw()+
  ggtitle("Habitat change (year - mean / mean)") +
  labs(y="Percentage change", x="Date") +theme(legend.position="")+
  coord_flip()

```


# Concerns: calculating anomalies and identifying MHWs

As I tried to foreshadow in the sections above, my main concern about our approach is how I am calculating SST anomaly and how this informs identifying MHWs. The way I identified MHWs is not conventional to other approaches (i.e. Hobday et al. or Jacox et al.) as my study only spans from 2012 - 2020 and I do not have a 30 year baseline period.

What Heather, Becca, and I have been wondering is instead of classifying MHW months within each management zone, which can get complicated and messy, maybe it would be more interpretative to classify MHW **years** over the entire spatial extent and then use this classification to distinguish changes between MHW and near average conditions, such as the center of gravity or "winner / losers" plots I have above. With this approach I also do not have to find another classification method of what a MHW year would be as I had to in the "winner / losers plot".

If that was confusing, lets go back to the center of gravity plot I above. This plot was created by: 1) classifying which months within a management zone was a MHW, which was done by finding the 90% quantile SST anomaly in that management zone and anything above that was classified as a "MHW" and anything below as "near-average", 2) taking the mean center of gravity for all "MHW" and "near-average" classified months. As a result this approach has a different number of MHWs for each management zone. **Instead** we are thinking of just classifying which years are MHW years (e.g. 2012 and 2016) over the entire spatial extent and using this classification to see changes in center of gravity during "MHW" and "near-average" conditions within management zones. 


To move forward we thought it would be important to show the SST anomalies which were calculated by:

$\frac{monthly\ mean - monthly\ climatology}{monthly\ SD}$

This is like saying how does June 2012 differ from all Junes within the time period or how November 2015 differs from all Novembers. Below is a plot of this calculation where the grey lines are the 90% quantile for each year, the blue dotted line the mean of those yearly quantiles, and the red is the 90% quantile of the entire time series
```{r}
#SST monthly anomaly

NWA_SST_anom<-stack("E:/VDM_results/NWA_PLL/monthly/sst/SST_month_anom_stack_2012to2020.nc")

NWA_SST_anom_timeseries<-cellStats(NWA_SST_anom,"mean") %>% 
  as.data.frame() %>% rownames_to_column()

colnames(NWA_SST_anom_timeseries)<-c("date","mean_sst_anom")

NWA_SST_anom_timeseries$date<-seq(as.Date("2012-01-01"), as.Date("2020-12-01"), by="month") %>% as.yearmon()


#getting the 90 percentile for each year
NWA_SST_anom_timeseries$year<-lubridate::year(NWA_SST_anom_timeseries$date)

yearly_quanitle<-tapply(NWA_SST_anom_timeseries$mean_sst_anom,
       NWA_SST_anom_timeseries$year,
       quantile, prob = c(.9)) %>% as.data.frame() %>% 
  rownames_to_column() %>% rename("year" = "rowname", "90"=".")

total_timeseries<-NWA_SST_anom_timeseries$mean_sst_anom %>% quantile(., prob=c(.9))


ggplot()+
  geom_line(NWA_SST_anom_timeseries,mapping = aes(x=date, y=mean_sst_anom))+
  geom_hline(aes(yintercept = yearly_quanitle$`90`),color = "gray69")+
  geom_hline(aes(yintercept = mean(yearly_quanitle$`90`),
                 color = "Mean 90% quantile"),
             linetype = "dashed",
             size = 1)+
  geom_hline(aes(yintercept = total_timeseries,
             color = "90% quantile"),
             linetype="dashed",
             size = 1)+
  theme_classic()+xlab("Date")+ylab("SST Anomaly")+
  labs(title="NW Atlantic SST Monthly Anomaly")+
  scale_color_discrete(name = "")
```

From this it looks like 2012, 2016, 2019, 2020 are all anomalously hotter years, which is not surprising because prominent MHWs have been identified within these years (2012 and 2016 in the literature and personal communication from Kathy and Andrew about 2019 and 2020). 

We can take a closer look at each years to give you a better idea of what they look like.
```{r}
yr_qunatile<-data.frame(quant90yr=yearly_quanitle$`90`, year=seq(2012,2020,by=1))

NWA_SST_anom_timeseries1<-left_join(NWA_SST_anom_timeseries,yr_qunatile)

ggplot(NWA_SST_anom_timeseries1)+
  geom_line(aes(x=date, y=mean_sst_anom))+
  geom_hline(aes(yintercept = quant90yr, color = "yearly 90% quantile"),color = "gray69")+
  geom_hline(aes(yintercept = mean(yearly_quanitle$`90`),
                 color = "Mean 90% quantile"),
             linetype = "dashed",
             size = 1)+
  geom_hline(aes(yintercept = total_timeseries,
             color = "90% quantile"),
             linetype="dashed",
             size = 1)+
  facet_wrap(~year, scales = "free_x")+
  theme_bw()+xlab("Date")+ylab("SST Anomaly")+
  labs(title="NW Atlantic SST Monthly Anomaly by year")+
  scale_color_discrete(name = "")

```

# Summarize and questions

Re-cap of what I have done to this point and how we want to move forward:
* We are taking a management zone perspective to see how suitable fishing habitat changes during MHW conditions
  + Results have shown that some management zones are winners while others are losers
  
* We have taken an unconventional way of classifying MHWs **months** by looking at when SST monthly anomalies are above the 90% quantile within a management zone.
  + This lead to also classifying MHW **years** as years with > 1 MHW month with a management zone
  
* We have concerns in our approach and would like to know if we can make our approach in identifying MHWs more valid and appropriate by looking at SST anomalies over the entire spatial extent and classifying MHW years that way.
  
* Questions:
  1. Would it be safe to say that we can classify (2012,2016,2019,2020) as MHW years and re-due the analysis above but with this classification? 
    + If not, should we use a threshold such as one of the threshold I showed above or maybe a seasonally varying threshold? 
    + Or should I get a baseline and calculate anomalies and classify MHWs the conventional way (HYCOM dates back to 1992-10-02 so I would get a baseline from then to 2011-12-31). 
      + * The reason why I haven't done this is because I won't be able to do this for my VDM predictions so the anomalies will be not comparable* 
  
  2. If we do go towards the threshold route, I was thinking it may be beneficial to do a sensitivity analysis on different threshold levels to make sure that our patterns don't change. 
  
  3. Is it okay to look at these SST anomalies over the entire extent or should we be doing it by management zone as I have done already?
